package com.example.ProTaskifyAPI.ServiceImpl;

import com.example.ProTaskifyAPI.DTO.ResponseObject;
import com.example.ProTaskifyAPI.DTO.Resquest.CreateSprintRequest;
import com.example.ProTaskifyAPI.Models.Process;
import com.example.ProTaskifyAPI.Models.ProcessCompositeKey;
import com.example.ProTaskifyAPI.Models.Sprint;
import com.example.ProTaskifyAPI.Repositories.FeatureRepo;
import com.example.ProTaskifyAPI.Repositories.ProcessRepo;
import com.example.ProTaskifyAPI.Repositories.ProjectRepo;
import com.example.ProTaskifyAPI.Repositories.SprintRepo;
import com.example.ProTaskifyAPI.Services.SprintService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor
public class SprintServiceImpl implements SprintService {
  private final SprintRepo sprintRepo;
  private final ProjectRepo projectRepo;
  private final ProcessRepo processRepo;
  private final FeatureRepo featureRepo;

  @Override
  public ResponseEntity<ResponseObject> createSprint(
      Integer projectId, CreateSprintRequest sprintRequest) {
    try {
      Sprint sprint =
          Sprint.builder()
              .sprint_name(sprintRequest.getSprint_name())
              .end_date(sprintRequest.getEnd_date())
              .deleted(false)
              .start_date(sprintRequest.getStart_date())
              .feedback(sprintRequest.getFeedback())
              .status("Pending")
              .build();
      var savedSprint = sprintRepo.save(sprint);
      autoGenerated_Process(savedSprint, projectId, null);
      return ResponseEntity.ok(new ResponseObject("Successful", "Created sprint", savedSprint));
    } catch (Exception e) {
      return ResponseEntity.status(HttpStatus.BAD_REQUEST)
          .body(new ResponseObject("Failed", "Create failed", null));
    }
  }

  @Override
  public ResponseEntity<ResponseObject> deleteSprint(Integer sprintId) {
    try {
      var sprint = sprintRepo.findById(sprintId).orElse(null);
      if (sprint != null) {
        sprint.setDeleted(true);
        sprintRepo.save(sprint);
        return ResponseEntity.ok(new ResponseObject("Successful", "Deleted sprint", sprint));
      } else {
        return ResponseEntity.status(HttpStatus.NOT_FOUND)
            .body(new ResponseObject("Failed", "Can't find sprint", null));
      }
    } catch (Exception e) {
      return ResponseEntity.status(HttpStatus.CONFLICT)
          .body(new ResponseObject("Failed", "Conflicted", null));
    }
  }

  public void autoGenerated_Process(Sprint sprint, Integer projectId, Integer featureId) {
    var project = projectRepo.findById(projectId).orElse(null);
    if (project != null && featureId == null) {
      Process process =
          Process.builder()
              .id(
                  ProcessCompositeKey.builder()
                      .feature(0)
                      .project(projectId)
                      .sprint(sprint.getSprint_id())
                      .build())
              .project(project)
              .sprint(sprint)
              .feature(null)
              .build();
      processRepo.save(process);
    } else {
      var feature = featureRepo.findById(featureId).orElse(null);
      Process process =
          Process.builder()
              .id(
                  ProcessCompositeKey.builder()
                      .feature(featureId)
                      .project(projectId)
                      .sprint(sprint.getSprint_id())
                      .build())
              .project(project)
              .sprint(sprint)
              .feature(feature)
              .build();
      processRepo.save(process);
    }
  }
}
